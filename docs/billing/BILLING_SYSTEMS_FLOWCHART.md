# Billing Systems Flowchart

## LLM API Call Flow - Complete System Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER MAKES LLM API CALL                        â”‚
â”‚                 POST /api/v1/llm/chat/completions                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: USAGE TRACKING MIDDLEWARE (Pre-Check)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Extract user_id from session cookie                            â”‚
â”‚  â€¢ Lookup subscription tier (trial/starter/pro/enterprise)        â”‚
â”‚  â€¢ Check Redis: usage:{user_id}:{YYYY-MM}:calls                  â”‚
â”‚  â€¢ Compare with tier limit (700/1k/10k/unlimited)                â”‚
â”‚                                                                    â”‚
â”‚  Decision:                                                         â”‚
â”‚    âŒ Over limit? â†’ 429 Too Many Requests (BLOCKED)              â”‚
â”‚    âœ… Within limit? â†’ Continue to handler                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: LITELLM API HANDLER (Cost Estimation)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Detect provider from model name                                â”‚
â”‚  â€¢ Check for BYOK key (OpenRouter/OpenAI/Anthropic)              â”‚
â”‚  â€¢ Estimate tokens: sum(len(msg.content.split()) * 1.5)          â”‚
â”‚  â€¢ Calculate estimated cost:                                      â”‚
â”‚      cost = (tokens/1000) * base_cost * power_mult * tier_markup â”‚
â”‚                                                                    â”‚
â”‚  BYOK Route:                                                      â”‚
â”‚    ðŸ’° Has BYOK? â†’ Skip credit check, use user's API key          â”‚
â”‚                                                                    â”‚
â”‚  Managed Route:                                                   â”‚
â”‚    ðŸ’³ No BYOK? â†’ Check credits...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: ORGANIZATIONAL CREDITS (Pre-Check)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Query: SELECT org_id FROM organization_members                â”‚
â”‚           WHERE user_id = {user_id} AND is_default = true        â”‚
â”‚  â€¢ Query: SELECT allocated_credits, used_credits                 â”‚
â”‚           FROM user_credit_allocations                            â”‚
â”‚           WHERE org_id = {org_id} AND user_id = {user_id}       â”‚
â”‚  â€¢ Check: remaining_credits >= estimated_cost                    â”‚
â”‚                                                                    â”‚
â”‚  Decision:                                                         â”‚
â”‚    âœ… Has org + sufficient credits? â†’ Use org billing            â”‚
â”‚    âŒ Has org + insufficient credits? â†’ 402 Payment Required     â”‚
â”‚    âšª No org? â†’ Fallback to individual credits...                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3b: INDIVIDUAL CREDITS (Fallback)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Query Redis: credits:balance:{user_id}                        â”‚
â”‚  â€¢ Fallback DB: SELECT credits_remaining FROM user_credits       â”‚
â”‚  â€¢ Check: credits_remaining >= estimated_cost                    â”‚
â”‚  â€¢ Check monthly cap (if configured)                              â”‚
â”‚                                                                    â”‚
â”‚  Decision:                                                         â”‚
â”‚    âœ… Sufficient credits + within cap? â†’ Continue                â”‚
â”‚    âŒ Insufficient credits? â†’ 402 Payment Required               â”‚
â”‚    âŒ Monthly cap exceeded? â†’ 429 Too Many Requests              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: PROVIDER API CALL                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Build request:                                                   â”‚
â”‚    â€¢ messages: [{role, content}, ...]                            â”‚
â”‚    â€¢ model: "gpt-4o" / "claude-3-opus" / etc.                   â”‚
â”‚    â€¢ max_tokens: 2000-16000 (based on power level)              â”‚
â”‚    â€¢ temperature: 0.3-0.8 (based on power level)                â”‚
â”‚                                                                    â”‚
â”‚  BYOK Route:                                                      â”‚
â”‚    POST https://api.openai.com/v1/chat/completions               â”‚
â”‚    Authorization: Bearer {user's API key}                        â”‚
â”‚                                                                    â”‚
â”‚  Managed Route:                                                   â”‚
â”‚    POST https://openrouter.ai/api/v1/chat/completions           â”‚
â”‚    Authorization: Bearer {system API key}                        â”‚
â”‚    HTTP-Referer: https://your-domain.com                     â”‚
â”‚                                                                    â”‚
â”‚  Wait for response: ~500-3000ms                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: RESPONSE PROCESSING                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Parse response:                                                  â”‚
â”‚    {                                                               â”‚
â”‚      "choices": [{...}],                                          â”‚
â”‚      "usage": {                                                   â”‚
â”‚        "prompt_tokens": 1000,                                     â”‚
â”‚        "completion_tokens": 500,                                  â”‚
â”‚        "total_tokens": 1500                                       â”‚
â”‚      }                                                             â”‚
â”‚    }                                                               â”‚
â”‚                                                                    â”‚
â”‚  Calculate actual cost:                                           â”‚
â”‚    cost = (1500 / 1000) * 0.015 * 0.25 * 1.6                    â”‚
â”‚         = 0.009 credits                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: CREDIT DEDUCTION                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BYOK Route (No charge):                                          â”‚
â”‚    cost = 0.0                                                     â”‚
â”‚    Skip all deductions                                            â”‚
â”‚                                                                    â”‚
â”‚  Organizational Billing:                                          â”‚
â”‚    BEGIN TRANSACTION;                                             â”‚
â”‚    UPDATE user_credit_allocations                                â”‚
â”‚      SET used_credits = used_credits + 9000  -- millicredits    â”‚
â”‚      WHERE org_id = {org_id} AND user_id = {user_id};          â”‚
â”‚                                                                    â”‚
â”‚    INSERT INTO credit_usage_attribution (                        â”‚
â”‚      user_id, org_id, service_type, credits_used, metadata      â”‚
â”‚    ) VALUES (                                                     â”‚
â”‚      {user_id}, {org_id}, 'llm_inference', 9000,                â”‚
â”‚      '{"provider":"openrouter","model":"gpt-4o","tokens":1500}' â”‚
â”‚    );                                                             â”‚
â”‚    COMMIT;                                                        â”‚
â”‚                                                                    â”‚
â”‚  Individual Billing (Fallback):                                  â”‚
â”‚    BEGIN TRANSACTION;                                             â”‚
â”‚    UPDATE user_credits                                           â”‚
â”‚      SET credits_remaining = credits_remaining - 0.009           â”‚
â”‚      WHERE user_id = {user_id};                                 â”‚
â”‚                                                                    â”‚
â”‚    INSERT INTO credit_transactions (                             â”‚
â”‚      user_id, amount, transaction_type, provider, model, tokens â”‚
â”‚    ) VALUES (                                                     â”‚
â”‚      {user_id}, -0.009, 'usage', 'openrouter', 'gpt-4o', 1500  â”‚
â”‚    );                                                             â”‚
â”‚    COMMIT;                                                        â”‚
â”‚                                                                    â”‚
â”‚  Invalidate Redis cache: credits:balance:{user_id}              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: LLM USAGE LOGGING                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INSERT INTO llm_usage_logs (                                    â”‚
â”‚    user_id, provider_id, model_name,                             â”‚
â”‚    input_tokens, output_tokens, cost,                            â”‚
â”‚    latency_ms, power_level                                       â”‚
â”‚  ) VALUES (                                                       â”‚
â”‚    {user_id}, {provider_uuid}, 'gpt-4o',                        â”‚
â”‚    1000, 500, 0.009,                                             â”‚
â”‚    1250, 'balanced'                                              â”‚
â”‚  );                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: USAGE TRACKING (Post-Increment)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Redis (fast counters):                                           â”‚
â”‚    INCR usage:{user_id}:2025-11:calls  â†’ 9876                   â”‚
â”‚    EXPIRE usage:{user_id}:2025-11:calls 2592000  # 30 days      â”‚
â”‚    INCR usage:{user_id}:2025-11-14:calls  â†’ 42                  â”‚
â”‚    EXPIRE usage:{user_id}:2025-11-14:calls 86400  # 24 hours    â”‚
â”‚                                                                    â”‚
â”‚  PostgreSQL (persistent):                                         â”‚
â”‚    INSERT INTO api_usage (                                       â”‚
â”‚      user_id, org_id, endpoint, method, response_status,        â”‚
â”‚      tokens_used, cost_credits, billing_period                  â”‚
â”‚    ) VALUES (                                                     â”‚
â”‚      {user_id}, {org_id}, '/api/v1/llm/chat/completions',      â”‚
â”‚      'POST', 200, 1500, 0.009, '2025-11'                        â”‚
â”‚    );                                                             â”‚
â”‚                                                                    â”‚
â”‚    UPDATE usage_quotas                                           â”‚
â”‚      SET api_calls_used = api_calls_used + 1                    â”‚
â”‚      WHERE user_id = {user_id};                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 9: LAGO EVENT RECORDING (Optional)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST https://billing-api.your-domain.com/api/v1/events     â”‚
â”‚  {                                                                 â”‚
â”‚    "event": {                                                     â”‚
â”‚      "transaction_id": "req_abc123",                             â”‚
â”‚      "external_customer_id": {org_id},                           â”‚
â”‚      "code": "api_call",                                          â”‚
â”‚      "timestamp": 1731628800,                                     â”‚
â”‚      "properties": {                                              â”‚
â”‚        "endpoint": "/api/v1/llm/chat/completions",              â”‚
â”‚        "tokens": 1500,                                            â”‚
â”‚        "model": "gpt-4o",                                         â”‚
â”‚        "user_id": {user_id},                                     â”‚
â”‚        "org_id": {org_id}                                        â”‚
â”‚      }                                                             â”‚
â”‚    }                                                               â”‚
â”‚  }                                                                 â”‚
â”‚                                                                    â”‚
â”‚  Note: This is informational only, not used for enforcement      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 10: RESPONSE TO USER                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HTTP 200 OK                                                      â”‚
â”‚                                                                    â”‚
â”‚  Headers:                                                         â”‚
â”‚    X-RateLimit-Limit: 10000                                      â”‚
â”‚    X-RateLimit-Remaining: 9875                                   â”‚
â”‚    X-RateLimit-Reset: 1731628800                                 â”‚
â”‚    X-RateLimit-Tier: professional                                â”‚
â”‚    X-Provider-Used: OpenRouter                                   â”‚
â”‚    X-Cost-Incurred: 0.009                                        â”‚
â”‚    X-Credits-Remaining: 9991.0                                   â”‚
â”‚                                                                    â”‚
â”‚  Body:                                                            â”‚
â”‚    {                                                               â”‚
â”‚      "id": "chatcmpl-abc123",                                    â”‚
â”‚      "object": "chat.completion",                                â”‚
â”‚      "created": 1731628800,                                       â”‚
â”‚      "model": "gpt-4o",                                           â”‚
â”‚      "choices": [{                                                â”‚
â”‚        "index": 0,                                                â”‚
â”‚        "message": {                                               â”‚
â”‚          "role": "assistant",                                    â”‚
â”‚          "content": "Hello! How can I help you today?"          â”‚
â”‚        },                                                         â”‚
â”‚        "finish_reason": "stop"                                   â”‚
â”‚      }],                                                          â”‚
â”‚      "usage": {                                                   â”‚
â”‚        "prompt_tokens": 1000,                                    â”‚
â”‚        "completion_tokens": 500,                                 â”‚
â”‚        "total_tokens": 1500                                      â”‚
â”‚      }                                                             â”‚
â”‚    }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## System Responsibilities at Each Step

| Step | Usage Tracking | Org Credits | LiteLLM | Lago |
|------|:--------------:|:-----------:|:-------:|:----:|
| 1. Pre-check quota | âœ… PRIMARY | | | |
| 2. Estimate cost | | | âœ… PRIMARY | |
| 3. Check credits | | âœ… PRIMARY | âšª Fallback | |
| 4. API call | | | âœ… Routes | |
| 5. Parse response | | | âœ… PRIMARY | |
| 6. Deduct credits | | âœ… PRIMARY | âšª Fallback | |
| 7. Log usage | | | âœ… PRIMARY | |
| 8. Increment counters | âœ… PRIMARY | | | |
| 9. Record event | | | | âšª Optional |
| 10. Return response | âœ… Headers | âœ… Headers | âœ… Body | |

**Legend**:
- âœ… PRIMARY: Main responsibility
- âšª Fallback/Optional: Secondary or informational
- (blank): Not involved

---

## Monthly Billing Cycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MONTH START (November 1st)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAGO: Charge Subscription Fee                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Generate invoice for Professional Plan ($49)                 â”‚
â”‚  â€¢ Charge Stripe payment method                                 â”‚
â”‚  â€¢ Send invoice email to org admin                              â”‚
â”‚  â€¢ Mark subscription as "active"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ORG CREDITS: Purchase Credits (Optional)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Admin visits /admin/credits                                  â”‚
â”‚  â€¢ Purchases $100 worth of credits (10,000 credits)            â”‚
â”‚  â€¢ Stripe processes payment                                     â”‚
â”‚  â€¢ UPDATE organization_credit_pools                             â”‚
â”‚     SET total_credits = total_credits + 10000000  -- millicreds â”‚
â”‚  â€¢ Credits available for allocation                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ORG CREDITS: Allocate to Users                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Admin allocates credits to team:                             â”‚
â”‚    - User A: 3,000 credits                                      â”‚
â”‚    - User B: 3,000 credits                                      â”‚
â”‚    - User C: 2,000 credits                                      â”‚
â”‚    - User D: 1,000 credits                                      â”‚
â”‚    - User E: 1,000 credits                                      â”‚
â”‚  â€¢ INSERT INTO user_credit_allocations (...)                   â”‚
â”‚  â€¢ UPDATE organization_credit_pools                             â”‚
â”‚     SET allocated_credits = 10000000                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USAGE TRACKING: Reset Quotas                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ DELETE FROM Redis: usage:{user_id}:2025-10:calls            â”‚
â”‚  â€¢ UPDATE usage_quotas                                          â”‚
â”‚     SET api_calls_used = 0,                                     â”‚
â”‚         reset_date = '2025-12-01'                               â”‚
â”‚  â€¢ Users now have fresh 10,000 API calls quota                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DURING MONTH: API Calls                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Users make LLM API calls                                     â”‚
â”‚  â€¢ Usage Tracking: api_calls_used increments                   â”‚
â”‚  â€¢ Org Credits: used_credits increments                         â”‚
â”‚  â€¢ LiteLLM: llm_usage_logs records inserted                    â”‚
â”‚  â€¢ Lago: events optionally recorded                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MONTH END (November 30th)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USAGE TRACKING: Generate Reports                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Total API calls: 9,750 (within 10,000 limit)                â”‚
â”‚  â€¢ Per-user breakdown available                                 â”‚
â”‚  â€¢ Per-endpoint analytics available                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ORG CREDITS: Usage Summary                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Total credits used: 9,500                                    â”‚
â”‚  â€¢ Remaining credits: 500 (roll over to next month)            â”‚
â”‚  â€¢ Cost: ~$95 (9,500 credits Ã— $0.01)                         â”‚
â”‚  â€¢ Per-user breakdown:                                          â”‚
â”‚    - User A: 2,800 used (200 remaining)                        â”‚
â”‚    - User B: 2,400 used (600 remaining)                        â”‚
â”‚    - User C: 1,900 used (100 remaining)                        â”‚
â”‚    - User D: 950 used (50 remaining)                           â”‚
â”‚    - User E: 1,450 used (0 remaining, over by 450)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LITELLM: Analytics Dashboard                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Total tokens processed: 14.2M                                â”‚
â”‚  â€¢ Average cost per request: $0.00095                          â”‚
â”‚  â€¢ Provider breakdown:                                          â”‚
â”‚    - OpenRouter: 9,500 requests ($95)                          â”‚
â”‚    - BYOK: 250 requests ($0 - user paid directly)             â”‚
â”‚  â€¢ Model breakdown:                                             â”‚
â”‚    - gpt-4o: 5,000 requests                                    â”‚
â”‚    - claude-3-opus: 3,500 requests                             â”‚
â”‚    - mixtral-8x7b: 1,000 requests                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAGO: Next Month Invoice                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Generate invoice for December                                â”‚
â”‚  â€¢ Subscription: $49                                            â”‚
â”‚  â€¢ (Org credits purchased separately, not on invoice)          â”‚
â”‚  â€¢ Charge on December 1st                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Tree: Which Billing System to Use

```
User makes LLM API call
    â”‚
    â–¼
Does user have BYOK key?
    â”‚
    â”œâ”€ YES â†’ Use user's API key
    â”‚         â”œâ”€ No credits charged
    â”‚         â”œâ”€ User pays provider directly
    â”‚         â”œâ”€ Still counts toward API quota (Usage Tracking)
    â”‚         â””â”€ Usage logged (LiteLLM)
    â”‚
    â””â”€ NO â†’ Using platform keys
           â”‚
           â–¼
       Does user belong to organization?
           â”‚
           â”œâ”€ YES â†’ Organizational Billing
           â”‚         â”œâ”€ Check org credit pool
           â”‚         â”œâ”€ Deduct from user's allocation
           â”‚         â”œâ”€ Log in credit_usage_attribution
           â”‚         â””â”€ Track API call (Usage Tracking)
           â”‚
           â””â”€ NO â†’ Individual Billing (Fallback)
                  â”œâ”€ Check individual credit balance
                  â”œâ”€ Deduct from user_credits
                  â”œâ”€ Log in credit_transactions
                  â””â”€ Track API call (Usage Tracking)
```

---

## Error Scenarios

### Scenario 1: Over API Quota
```
User makes request (10,001st call of month)
    â†“
Usage Tracking Middleware
    â”œâ”€ Check: usage:{user_id}:2025-11:calls = 10,000
    â”œâ”€ Limit: 10,000 (professional tier)
    â”œâ”€ Decision: 10,000 >= 10,000 â†’ BLOCKED
    â””â”€ Response: 429 Too Many Requests
       {
         "error": "Rate Limit Exceeded",
         "message": "You have exceeded your professional tier API call limit (10,000 calls per month).",
         "tier": "professional",
         "used": 10000,
         "limit": 10000,
         "remaining": 0,
         "reset_date": "2025-12-01",
         "upgrade_url": "/admin/subscription/plan"
       }
```

### Scenario 2: Insufficient Organization Credits
```
User makes LLM request
    â†“
LiteLLM Handler: Estimate cost = 0.05 credits
    â†“
Org Credits Integration
    â”œâ”€ Query: user_credit_allocations
    â”œâ”€ allocated_credits: 1,000,000 (1,000 credits)
    â”œâ”€ used_credits: 999,980 (999.98 credits)
    â”œâ”€ remaining: 20 (0.02 credits)
    â”œâ”€ Decision: 0.02 < 0.05 â†’ INSUFFICIENT
    â””â”€ Response: 402 Payment Required
       {
         "error": "Insufficient Credits",
         "detail": "Insufficient organization credits. Available: 0.02, needed: 0.05",
         "org_id": "org_e9c5241a...",
         "suggestion": "Contact your organization admin to purchase more credits"
       }
```

### Scenario 3: Monthly Spending Cap Exceeded
```
User makes LLM request
    â†“
LiteLLM Handler: Estimate cost = 0.01 credits
    â†“
Individual Credits
    â”œâ”€ Check balance: 50.00 credits âœ“
    â”œâ”€ Check monthly cap: $100 (100 credits)
    â”œâ”€ Query credit_transactions for current month
    â”œâ”€ Monthly spend so far: 100.5 credits
    â”œâ”€ Decision: 100.5 + 0.01 > 100 â†’ OVER CAP
    â””â”€ Response: 429 Too Many Requests
       {
         "error": "Monthly Spending Cap Exceeded",
         "detail": "Monthly spending cap exceeded",
         "monthly_cap": 100,
         "current_spend": 100.5,
         "suggestion": "Increase your monthly spending cap in settings"
       }
```

---

## Key Takeaway

**All four systems work together**:

1. **Lago** = "You pay $49/month for the service"
2. **Org Credits** = "Your organization has a pool of usage credits"
3. **Usage Tracking** = "You can make 10,000 API calls per month"
4. **LiteLLM** = "Each call costs X credits based on tokens/model/power"

**They are NOT duplicates** - they measure different things and serve different purposes!
